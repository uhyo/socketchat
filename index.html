<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>socket chat</title>
    <link href="/css.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <script src="/line.js"></script>
    <script>

function SocketChat(log,info,infobar){
	this.logid=log,this.infoid=info,this.infobarid=infobar;
	
	this.oldest_time=null;
	this.flags={"sound":true};
}
SocketChat.prototype={
	init:function(){
		this.log=document.getElementById(this.logid);
		this.info=document.getElementById(this.infoid);
		this.users=this.info.getElementsByClassName("users")[0];
		this.usernumber=this.info.getElementsByClassName("usernumber")[0];
		this.line=new HighChatMaker(document.getElementById(this.infobarid));
		
		this.usernumber.dataset.actives=this.usernumber.dataset.roms=0;
		this.bots=[];
		
		this.responding_to=null;	//dd
		
		//Audio
		if(this.flags.sound){
			var audio;
			var soundSource=[
				["./sound.ogg", "audio/ogg"],
				["./sound.mp3", "audio/mp3"],
				["./sound.wav", "audio/wav"]
			];
			try{
				audio=new Audio();
				audio.removeAttribute("src");
				soundSource.forEach(function(arr){
					var source=document.createElement("source");
					source.src=arr[0];
					source.type=arr[1];
					audio.appendChild(source);
				});
			}catch(e){
				audio={play:function(){}};
			}
			this.audio=audio;
		}
		
		//Responding tip
		this.responding_tip=document.createElement("span");
		this.responding_tip.textContent="⇒";
		this.responding_tip.classList.add("responding_tip");
		
		var socket;
		socket=this.socket = io.connect(location.origin);
		
		socket.on("init",this.loginit.bind(this));
		socket.on("log",this.recv.bind(this));
		socket.on("users",this.userinit.bind(this));
		socket.on("userinfo",this.userinfo.bind(this));
		socket.on("mottoResponse",this.mottoResponse.bind(this));
		socket.on("idresponse",this.idresponse.bind(this));
		socket.on("disconnect",this.disconnect.bind(this));
		socket.on("newuser",this.newuser.bind(this));
		socket.on("deluser",this.deluser.bind(this));
		socket.on("inout",this.inout.bind(this));
		
		/*document.forms["inout"].addEventListener("submit",this.submit.bind(this),false);
		document.forms["comment"].addEventListener("submit",this.submit.bind(this),false);*/
		document.addEventListener("submit",this.submit.bind(this),false);
		
		this.log.addEventListener('click',this.click.bind(this),false);
		
		if(localStorage.socketchat_name){
			document.forms["inout"].elements["uname"].value=localStorage.socketchat_name;
		}
		
		var hottomottob=document.getElementsByClassName("logs")[0].getElementsByClassName("hottomottobutton")[0];
		hottomottob.addEventListener("click",this.HottoMotto.bind(this),false);
		
		socket.emit("regist",{"mode":"client"});
	},
	loginit:function(data){
		data.logs.reverse().forEach(function(line){
			this.write(line);
		},this);
		if(data.logs.length)this.oldest_time=data.logs.shift().time;
	},
	recv:function(obj){
		this.bots.forEach(function(func){func(obj,this)},this);
		if(this.flags.sound){
			this.audio.play();
		}
		this.write(obj);
	},
	write:function(obj){
		this.log.insertBefore(this.line.make(obj),this.log.firstChild);
	},
	//誰かが来た
	newuser: function(user){
		console.log("newuser", user);
		var li=document.createElement("li");
		var sp=document.createElement("span");
		sp.textContent=user.name;
		sp.title=user.ip+" / "+user.ua;
		li.dataset.id=user.id;
		if(user.rom){
			li.classList.add("rom");
			this.setusernumber(0, 1);
		}else{
			this.setusernumber(1, 0);
		}
		
		li.appendChild(sp);
		this.users.appendChild(li);
	},
	getuserelement: function(id){
		var ul=this.users.childNodes;
		for(var i=0, l=ul.length; i<l; i++){
			if(ul[i].dataset.id==id){
				return ul[i];
			}
		}
		return null;
	},
	//誰かがお亡くなりに
	deluser: function(id){
		console.log("deluser", id);
		var elem=this.getuserelement(id);
		if(!elem) return;
		
		var actives=this.usernumber.dataset.actives, roms=this.usernumber.dataset.roms;
		if(elem.classList.contains("rom")){
			this.setusernumber(0, -1);
		}else{
			this.setusernumber(-1, 0);
		}
		this.users.removeChild(elem);
	},
	//最初にユーザリストを得る
	userinit:function(obj){
		console.log("userinit", obj);
		while(this.users.firstChild)this.users.removeChild(this.users.firstChild);//textNode消す
		
		obj.users.forEach(this.newuser, this);
		//this.setusernumber(obj.actives, obj.roms);
	},
	//人数をセットして反映
	setusernumber: function(actives, roms){
		var dataset=this.usernumber.dataset;
		dataset.actives=parseInt(dataset.actives)+actives;
		dataset.roms=parseInt(dataset.roms)+roms;
		this.usernumber.textContent="入室"+dataset.actives+(dataset.roms!=0? " (ROM"+dataset.roms+")":"");
	},
	//誰かが入退室
	inout: function(obj){
		console.log("inout", obj);
		var elem=this.getuserelement(obj.id);
		if(!elem)return;
		elem.firstChild.textContent=obj.name;
		if(obj.rom){
			elem.classList.add("rom");
			this.setusernumber(-1, 1);
		}else{
			elem.classList.remove("rom");
			this.setusernumber(1, -1);
		}
	},
	//自分が入退室
	userinfo:function(obj){
		var f=document.forms["inout"];
		f.elements["uname"].disabled=!obj.rom;
		
		var result=document.evaluate('descendant::input[@type="submit"]',f,null,XPathResult.ANY_UNORDERED_NODE_TYPE,null);
		var bt=result.singleNodeValue;
		bt.value=obj.rom?"入室":"退室";
		this.inout(obj);
	},
	mottoResponse:function(data){
		data.logs.forEach(function(line){
			this.log.appendChild(this.line.make(line));
		},this);
		if(data.logs.length)this.oldest_time=data.logs.pop().time;
	},
	HottoMotto:function(e){
		this.socket.emit("motto",{"time":this.oldest_time});
	},
	
	submit:function(e){
		var f=e.target;
		if(f.name=="inout"){
			//入退室
			var el=f.elements["uname"];
			this.socket.emit("inout",{"name":el.value});
			
			localStorage.socketchat_name=el.value;
		}else if(f.name=="comment"){
			//発言
			var el=f.elements["comment"];
			this.say(f);
			el.value="";
			f.elements["response"].value="";
			this.responding_tip.parentNode && this.responding_tip.parentNode.removeChild(this.responding_tip);
		}
		e.preventDefault();
	},
	say:function(f){
		this.socket.emit("say",{"comment":f.elements["comment"].value,"response":f.elements["response"].value});
	},
	
	bot:function(func){
		this.bots.push(func);
	},
	click:function(e){
		var t=e.target;
		if(t.isSameNode(this.responding_tip)){
			e.stopPropagation();
			
			document.forms["comment"].elements["response"].value=this.responding_tip.dataset.to;
			document.forms["comment"].elements["comment"].focus();
			this.responding_tip.classList.add("checked");
			return;
		}
		var dd=document.evaluate('ancestor-or-self::dd',t,null,XPathResult.ANY_UNORDERED_NODE_TYPE,null).singleNodeValue;
		if(!dd){

			this.responding_tip.parentNode && this.responding_tip.parentNode.removeChild(this.responding_tip);
			return;
		}
		if(dd.classList.contains("respto") && dd.dataset.open!="open"){
			//開く
			this.responding_to=dd;
			this.socket.emit("idrequest",{"id":dd.dataset.respto});
			dd.dataset.open="open";
			return;
		}
		//コメント
		this.responding_tip.classList.remove("checked");

		document.forms["comment"].elements["response"].value="";
		dd.appendChild(this.responding_tip);
		this.responding_tip.dataset.to=dd.dataset.id;
	},
	idresponse:function(data){
		if(!this.responding_to || !data)return;
		var line=this.line.make(data);
		for(var i=0,l=line.childNodes.length;i<l;i++){
			line.childNodes[i].classList && line.childNodes[i].classList.add("resp");
		}
		var r=this.responding_to;
		r.parentNode.insertBefore(line,r.nextSibling);
		
	},
	disconnect:function(){
		document.body.classList.add("discon");
	}
	
};
    </script>
    <script>
Chat=new SocketChat("log","info","infobar");
window.addEventListener('load',function(){
	Chat.init();
},false);
    </script>
  </head>
  <body>
  <div class="forms">
    <div id="infobar"></div>
    <form name="inout">
      <p><input name="uname" size="20" maxlength="25" required><input type="submit" value="入室"></p>
    </form>
    <form name="comment">
      <p><input name="comment" size="70" autocomplete="off" required><input type="submit" value="発言"></p>
      <input type="hidden" name="response" value="">
    </form>
  </div>
  <div class="logs">
    <dl id="log">
    </dl>
    <p><button class="hottomottobutton">HottoMotto</button></p>
  </div>
  <div id="info">
    <span class="usernumber"></span>
    <ul class="users">
    </ul>
  </div>
  </body>
</html>
